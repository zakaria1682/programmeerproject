{% extends "layout.html" %}

{% block title %}
    Dialoog · {{ thread.title }}
{% endblock %}

{% block extra_head %} {% endblock %}

{% block main %}

<div class="container mt-4" style="max-width: 1500px; color:#f9fafb;">

    <div class="thread-layout">

        <div class="thread-main">

            <div class="thread-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex align-items-center">
                        <div class="blog-thumb">
                            {% if thread.author.profile_image %}
                                <img src="{{ url_for('static', filename='profile_pics/' ~ thread.author.profile_image) }}"
                                     alt="Profielfoto"
                                     class="blog-thumb-img">
                            {% else %}
                                {{ (thread.author.first_name or thread.author.username)[0] | upper }}
                            {% endif %}
                        </div>
                        <div>
                            <h2 class="mb-1">{{ thread.title }}</h2>
                            <div class="thread-meta">
                                Gestart door {{ thread.author.full_name or thread.author.username }}
                                · {{ thread.created_at|nl_datetime }}
                                · {{ all_comments|length }} reacties
                            </div>
                        </div>
                    </div>
                    {% if user and (user.id == thread.author_id or user.has_role('admin') or user.has_role('superadmin')) %}
                        <div class="blog-action-buttons">
                            <button type="button"
                                    class="btn btn-outline-light btn-sm"
                                    data-thread-edit-toggle="1">
                                Bewerken
                            </button>
                            {% if user.has_role('admin') or user.has_role('superadmin') %}
                                <form method="post"
                                      action="{{ url_for('delete_thread', thread_id=thread.id) }}"
                                      onsubmit="return confirm('Weet je zeker dat je deze hele dialoog wilt verwijderen?');">
                                    <button type="submit"
                                            class="btn btn-outline-danger btn-sm">
                                        Verwijderen
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="tts-controls">
                    <span id="tts-support-info">Dialoog laten voorlezen:</span>
                    <button id="tts-play"  type="button">▶ Afspelen</button>
                    <button id="tts-pause" type="button">⏯ Pauze / Hervat</button>
                    <button id="tts-stop"  type="button">⏹ Stop</button>

                    <div class="tts-speed-wrapper">
                        <label for="tts-rate" class="mb-0">Snelheid</label>
                        <input type="range" id="tts-rate" min="0.5" max="2" step="0.1" value="1.5">
                        <span id="tts-rate-value">1.5</span>x
                    </div>
                </div>


                {% if thread.body %}
                    <hr style="border-color: rgba(55,65,81,0.7);">
                    <div id="thread-content" class="mt-3" style="font-size:0.95rem; line-height:1.6;">
                        {{ thread.body | safe }}
                    </div>
                {% endif %}


                {% if user and (user.id == thread.author_id or user.has_role('admin') or user.has_role('superadmin')) %}
                    <div class="d-flex align-items-center justify-content-between mt-3">
                        <div class="blog-action-buttons">
                            <button type="button"
                                    class="btn btn-outline-light btn-sm"
                                    data-thread-edit-toggle="1">
                                Bewerken
                            </button>

                            {% if user.has_role('admin') or user.has_role('superadmin') %}
                                <form method="post"
                                      action="{{ url_for('delete_thread', thread_id=thread.id) }}"
                                      onsubmit="return confirm('Weet je zeker dat je deze hele dialoog wilt verwijderen?');">
                                    <button type="submit"
                                            class="btn btn-outline-danger btn-sm">
                                        Verwijderen
                                    </button>
                                </form>
                            {% endif %}
                        </div>

                        <button type="button"
                                class="thread-share-btn"
                                data-share-url="{{ url_for('view_thread', thread_id=thread.id, _external=True) }}"
                                data-share-title="{{ thread.title }}">
                            Delen
                        </button>
                    </div>
                {% endif %}


                {% if user and (user.id == thread.author_id or user.has_role('admin') or user.has_role('superadmin')) %}
                    <div id="thread-edit-form" class="mt-3" style="display:none;">
                        <form method="post"
                              action="{{ url_for('edit_thread', thread_id=thread.id) }}"
                              enctype="multipart/form-data">

                            <div class="mb-2">
                                <label for="thread-title" class="form-label">Titel</label>
                                <input type="text"
                                       id="thread-title"
                                       name="title"
                                       class="form-control"
                                       placeholder="Titel van de dialoog (max 255 tekens)"
                                       value="{{ thread.title }}"
                                       required
                                       maxlength="255">
                            </div>

                            <div class="mb-2">
                                <label for="thread-thumbnail" class="form-label">
                                    Thumbnail (afbeelding, gif of video)
                                </label>
                                <input type="file"
                                       id="thread-thumbnail"
                                       name="thumbnail"
                                       class="form-control"
                                       accept="image/*,video/*">
                                <small class="form-text text-muted">
                                    Laat leeg om de huidige thumbnail te behouden.
                                </small>
                            </div>

                            <div class="mb-2">
                                <label for="thread-body-editor" class="form-label">Startpost / toelichting</label>
                                <textarea id="thread-body-editor"
                                          name="body"
                                          class="form-control thread-editor"
                                          rows="4">{{ thread.body | safe }}</textarea>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    Wijzigingen opslaan
                                </button>
                            </div>
                        </form>
                    </div>
                {% endif %}

            </div>

            <div class="new-comment-card" id="comments">
                {% if user %}

                    {% if request.args.get('comment') == 'posted' %}
                        <div class="alert alert-success py-1 px-2 mb-2"
                             style="font-size:0.85rem; border-radius:10px;">
                            Reactie geplaatst.
                        </div>
                    {% endif %}

                    <h6 class="mb-2">
                        <a href="#" id="toggle-new-comment" style="text-decoration:none;">
                            Nieuwe reactie
                        </a>
                    </h6>
                    <div id="new-comment-form" style="display:none;">
                        <form method="post" onsubmit="tinymce.triggerSave();">
                            <input type="hidden" name="parent_id" value="">
                            <div class="mb-2">
                                <textarea name="body"
                                          class="form-control comment-editor"
                                          rows="3"
                                          placeholder="Schrijf hier je reactie..."></textarea>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    Plaats reactie
                                </button>
                            </div>
                        </form>
                    </div>

                {% else %}
                    <p class="mb-1">
                        Log in om te reageren op deze dialoog.
                    </p>
                    <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">
                        Inloggen
                    </a>
                    <a href="{{ url_for('register') }}" class="btn btn-outline-light btn-sm ms-1">
                        Registreren
                    </a>
                {% endif %}
            </div>

            <div id="comments" class="comment-tree mt-3">
                {% macro render_comment(c) %}
                    <div class="comment-box" id="comment-{{ c.id }}">
                        <div class="comment-vote">
                            {% if user %}
                                <form method="post" action="{{ url_for('vote_comment', comment_id=c.id) }}">
                                    <input type="hidden" name="direction" value="up">
                                    <button type="submit">▲</button>
                                </form>
                            {% else %}
                                <span style="font-size:0.7rem;">▲</span>
                            {% endif %}
                            <div class="comment-score">{{ c.score }}</div>
                            {% if user %}
                                <form method="post" action="{{ url_for('vote_comment', comment_id=c.id) }}">
                                    <input type="hidden" name="direction" value="down">
                                    <button type="submit">▼</button>
                                </form>
                            {% else %}
                                <span style="font-size:0.7rem;">▼</span>
                            {% endif %}
                        </div>
                        <div class="comment-body-card">
                            <div class="comment-meta">
                                {{ c.author.full_name or c.author.username }}
                                · {{ c.created_at|nl_datetime }}
                            </div>
                            <div>
                                {{ c.body | safe }}
                            </div>
                            <div class="comment-actions">
                                {% if user %}
                                    <a href="#"
                                       data-reply-toggle="{{ c.id }}">
                                        Reageren
                                    </a>

                                    {% if user.id == c.author_id or user.has_role('admin') or user.has_role('superadmin') %}
                                        <a href="#"
                                           data-edit-toggle="{{ c.id }}">
                                            Bewerken
                                        </a>
                                        <form method="post"
                                              action="{{ url_for('delete_comment', comment_id=c.id) }}"
                                              style="display:inline;">
                                            <button type="submit"
                                                    class="btn-link-like"
                                                    onclick="return confirm('Weet je zeker dat je deze reactie wilt verwijderen?');">
                                                Verwijderen
                                            </button>
                                        </form>
                                    {% endif %}
                                {% else %}
                                    <span style="color:rgba(156,163,175,0.8);">
                                        Log in om te reageren
                                    </span>
                                {% endif %}
                            </div>

                            {% if user and (user.id == c.author_id or user.has_role('admin') or user.has_role('superadmin')) %}
                                <div id="edit-form-{{ c.id }}"
                                     class="reply-form"
                                     style="display:none;">
                                    <form method="post"
                                          action="{{ url_for('edit_comment', comment_id=c.id) }}"
                                          onsubmit="tinymce.triggerSave();">
                                        <div class="mb-1">
                                            <textarea name="body"
                                                      class="form-control comment-editor"
                                                      rows="3">{{ c.body }}</textarea>
                                        </div>
                                        <div class="text-end">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                Opslaan
                                            </button>
                                        </div>
                                    </form>
                                </div>

                            {% endif %}

                            {% if user %}
                                <div id="reply-form-{{ c.id }}"
                                     class="reply-form"
                                     style="display:none;">
                                    <form method="post" onsubmit="tinymce.triggerSave();">
                                        <input type="hidden" name="parent_id" value="{{ c.id }}">
                                        <div class="mb-1">
                                            <textarea name="body"
                                                      class="form-control comment-editor"
                                                      rows="2"
                                                      placeholder="Antwoord op {{ c.author.full_name or c.author.username }}..."></textarea>
                                        </div>
                                        <div class="text-end">
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                Plaats antwoord
                                            </button>
                                        </div>
                                    </form>
                                </div>

                            {% endif %}

                            {% if c.children %}
                                <div class="comment-children">
                                    {% for child in c.children|sort(attribute='created_at')|sort(attribute='score', reverse=True) %}
                                        {{ render_comment(child) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endmacro %}

                {% if root_comments %}
                    {% for comment in root_comments %}
                        {{ render_comment(comment) }}
                    {% endfor %}
                {% else %}
                    <p style="font-size:0.9rem; color:rgba(156,163,175,0.9);">
                        Nog geen reacties. Start de discussie met de eerste reactie.
                    </p>
                {% endif %}
            </div>

        </div>

        <div class="thread-divider"></div>

        <div class="thread-sidebar">
            <div class="thread-sidebar-card">
                <h5 class="mb-3">Wellicht ook interessant</h5>

                {% if sidebar_threads %}
                    {% for t in sidebar_threads %}
                        <a href="{{ url_for('view_thread', thread_id=t.id) }}"
                           class="thread-sidebar-item">
                            <div class="thread-sidebar-thumb">
                                {% if t.thumbnail_image %}
                                    <img src="{{ url_for('static', filename='dialogue_thumbs/' ~ t.thumbnail_image) }}"
                                         alt="Thumbnail">
                                {% else %}
                                    Geen<br>media
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <div class="thread-sidebar-title">
                                    {{ t.title }}
                                </div>
                                <div class="thread-sidebar-meta">
                                    {{ t.author.full_name or t.author.username }}
                                    · {{ t.created_at|nl_datetime }}
                                    {% set cnt = t.comments.count() %}
                                    · {{ cnt }} reactie{% if cnt != 1 %}s{% endif %}
                                </div>
                            </div>
                        </a>
                    {% endfor %}
                {% else %}
                    <p style="font-size:0.85rem; color:rgba(156,163,175,0.9);">
                        Geen andere dialogen gevonden.
                    </p>
                {% endif %}
            </div>
        </div>

    </div>

</div>

{% endblock %}
