{% extends "layout.html" %}

{% block title %}
    Opiniepeilingen
{% endblock %}

{% block extra_head %} {% endblock %}

{% block main %}

<div class="container mt-4" style="color:#f9fafb; max-width: 1650px;">

    <h1 class="mb-3">Opiniepeilingen</h1>

    <div class="opinion-page-wrapper">

        <div>
            <div class="opinion-cards-grid">

                {% if polls %}
                    {% for poll in polls %}
                        {% set expired = poll.expires_at and poll.expires_at <= now_utc %}
                        {% set total_votes = (poll.yes_count or 0) + (poll.no_count or 0) %}
                        {% set yes_pct = (poll.yes_count * 100 // total_votes) if total_votes > 0 else 0 %}
                        {% set no_pct = (poll.no_count * 100 // total_votes) if total_votes > 0 else 0 %}
                        {% set remaining_seconds = ((poll.expires_at - now_utc).total_seconds() if poll.expires_at and poll.expires_at > now_utc else 0) | int %}
                        {% set user_choice = user_votes.get(poll.id) %}

                        <div class="opinion-card{% if expired %} poll-closed{% endif %}"
                             data-poll-id="{{ poll.id }}"
                             data-remaining="{{ remaining_seconds }}">

                            <div class="opinion-title">
                                {{ poll.question }}
                            </div>

                            <div class="opinion-author-row">
                                <div class="opinion-author-info">
                                    {% if poll.author and poll.author.profile_image %}
                                        <img src="{{ url_for('static', filename='profile_pics/' ~ poll.author.profile_image) }}"
                                             alt="Profielfoto"
                                             class="opinion-author-avatar">
                                    {% else %}
                                        <div class="opinion-author-avatar d-flex align-items-center justify-content-center"
                                             style="background:#020617; font-size:0.9rem;">
                                            {{ (poll.author.first_name or poll.author.username)[:1]|upper }}
                                        </div>
                                    {% endif %}
                                    <div class="opinion-author-text">
                                        <div style="font-weight:600;">
                                            Door {{ poll.author.full_name if poll.author else 'Onbekend' }}
                                        </div>
                                        {% if poll.created_at %}
                                            <div class="text-muted">
                                                {{ poll.created_at|nl_datetime("%d-%m-%Y %H:%M") }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="poll-status-badge">
                                    {% if expired %}
                                        GESLOTEN
                                    {% else %}
                                        ACTIEF
                                    {% endif %}
                                </div>
                            </div>

                            <div class="poll-timer-pill">
                                {% if expired %}
                                    <span class="poll-timer-label">Afgerond</span>
                                    <span class="poll-timer-value">00:00:00</span>
                                {% else %}
                                    <span class="poll-timer-label">Resterende tijd</span>
                                    <span class="poll-timer-value">
                                        --
                                    </span>
                                {% endif %}
                            </div>

                            <div class="opinion-description">
                                {{ poll.description }}
                            </div>

                            <div class="poll-vote-area {% if expired %}d-none{% endif %}">
                                <div class="poll-vote-buttons">
                                    <form method="post"
                                          action="{{ url_for('vote_opinie', poll_id=poll.id) }}">
                                        <input type="hidden" name="choice" value="yes">
                                        <button type="submit"
                                                class="poll-vote-button poll-vote-button-yes w-100 {% if user_choice == 'yes' %}voted{% endif %}">
                                            Eens
                                        </button>
                                    </form>
                                    <form method="post"
                                          action="{{ url_for('vote_opinie', poll_id=poll.id) }}">
                                        <input type="hidden" name="choice" value="no">
                                        <button type="submit"
                                                class="poll-vote-button poll-vote-button-no w-100 {% if user_choice == 'no' %}voted{% endif %}">
                                            Oneens
                                        </button>
                                    </form>
                                </div>
                                <div class="mt-2 text-xs text-muted">
                                    Uitslag wordt zichtbaar zodra deze peiling is afgelopen.
                                </div>
                                {% if user_choice %}
                                    <div class="mt-1 text-xs">
                                        Jij hebt gestemd:
                                        <strong>
                                            {{ 'Eens' if user_choice == 'yes' else 'Oneens' }}
                                        </strong>.
                                    </div>
                                {% endif %}
                            </div>

                            <div class="poll-results-area {% if expired %}show-results{% else %}d-none{% endif %}">
                                <div class="poll-results-bars">
                                    <div class="poll-bar poll-bar-yes"
                                         style="--fill: {{ yes_pct }}%;"></div>
                                    <div class="poll-bar poll-bar-no"
                                         style="--fill: {{ no_pct }}%;"></div>
                                </div>
                                <div class="poll-results-text d-flex justify-content-between">
                                    <span>Eens: {{ poll.yes_count or 0 }} ({{ yes_pct }}%)</span>
                                    <span>Oneens: {{ poll.no_count or 0 }} ({{ no_pct }}%)</span>
                                </div>
                                <div class="poll-results-text text-muted">
                                    Totaal {{ total_votes }} stemmen
                                    {% if poll.expires_at %}
                                        Â· gesloten op {{ poll.expires_at|nl_datetime("%d-%m-%Y %H:%M") }}
                                    {% endif %}
                                </div>
                                {% if user_choice %}
                                    <div class="poll-results-text text-muted">
                                        Jij hebt gestemd:
                                        <strong>
                                            {{ 'Eens' if user_choice == 'yes' else 'Oneens' }}
                                        </strong>.
                                    </div>
                                {% endif %}
                            </div>

                            <div class="poll-footer-row">

                                {% set can_manage_time = user and (user.has_role('admin') or user.has_role('superadmin')) %}

                                {% if can_manage_time %}
                                    <button type="button"
                                            class="btn btn-outline-light btn-outline-small"
                                            onclick="toggleTimeForm({{ poll.id }})">
                                        Peilingtijd aanpassen
                                    </button>
                                {% else %}
                                    <span></span>
                                {% endif %}

                                {% if user and (user.id == poll.author_id
                                                or user.has_role('admin')
                                                or user.has_role('superadmin')) %}
                                    <form method="post"
                                          action="{{ url_for('delete_opinie', poll_id=poll.id) }}"
                                          onsubmit="return confirm('Weet je zeker dat je deze peiling wilt verwijderen?');">
                                        <button type="submit"
                                                class="btn btn-outline-danger btn-outline-small">
                                            Verwijderen
                                        </button>
                                    </form>
                                {% endif %}
                            </div>

                            {% if can_manage_time %}
                                <form method="post"
                                      action="{{ url_for('update_poll_time', poll_id=poll.id) }}"
                                      id="time-form-{{ poll.id }}"
                                      class="mt-2 d-none">
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="number"
                                               name="duration_value"
                                               min="1"
                                               step="1"
                                               class="form-control form-control-sm"
                                               placeholder="Duur"
                                               required>
                                        <select name="duration_unit"
                                                class="form-select form-select-sm">
                                            <option value="seconds">seconden</option>
                                            <option value="minutes">minuten</option>
                                            <option value="hours">uren</option>
                                            <option value="days">dagen</option>
                                        </select>
                                        <button type="submit"
                                                class="btn btn-primary btn-sm">
                                            Opslaan
                                        </button>
                                    </div>
                                    <div class="text-xs text-muted mt-1">
                                        Tussen 10 seconden en 30 dagen.
                                    </div>
                                </form>
                            {% endif %}

                            {% if expired %}
                                <form method="post"
                                      action="{{ url_for('poll_make_dialogue', poll_id=poll.id) }}">
                                    <button type="submit"
                                            class="btn btn-primary w-100 btn-make-dialogue">
                                        {% if poll.dialogue_thread_id %}
                                            Naar dialoog
                                        {% else %}
                                            Maak dialoog aan
                                        {% endif %}
                                    </button>
                                </form>
                            {% else %}
                                <form method="post"
                                      action="{{ url_for('poll_make_dialogue', poll_id=poll.id) }}"
                                      class="d-none">
                                    <button type="submit"
                                            class="btn btn-primary w-100 btn-make-dialogue">
                                        {% if poll.dialogue_thread_id %}
                                            Naar dialoog
                                        {% else %}
                                            Maak dialoog aan
                                        {% endif %}
                                    </button>
                                </form>
                            {% endif %}

                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Er zijn nog geen opiniepeilingen.</p>
                {% endif %}

            </div>
        </div>

        <aside class="opinion-side-panel">
            <h5 class="mb-2">Over de opiniepeilingen</h5>
            <ul class="mb-3">
                <li>Elke geregistreerde gebruiker kan een peiling starten.</li>
                <li>Stem met <strong>eens</strong> of <strong>oneens</strong>.</li>
                <li>De uitslag wordt zichtbaar zodra de peiling is afgelopen.</li>
                <li>Na afloop blijft de uitslag zichtbaar, maar stemmen kan dan niet meer.</li>
                <li>Bij elke peiling kan automatisch een dialoog worden gestart.</li>
            </ul>

            {% if user %}
                <button class="btn btn-poll-main w-100 mt-2"
                        data-bs-toggle="modal"
                        data-bs-target="#newPollModal"
                        style="border-radius: 0.9rem;">
                    Maak peiling aan
                </button>

            {% else %}
                <button class="btn btn-poll-main w-100 mt-2" disabled>
                    Log in om een peiling aan te maken
                </button>
            {% endif %}
        </aside>

    </div>
</div>

<div class="modal fade" id="newPollModal" tabindex="-1" aria-labelledby="newPollModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background:#020617; color:#f9fafb;">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="newPollModalLabel">Nieuwe peiling starten</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <form method="post"
                  action="{{ url_for('new_opinie') }}"
                  enctype="multipart/form-data">
                <div class="modal-body">

                    <div class="mb-3">
                        <label for="question" class="form-label">Vraag</label>
                        <input type="text"
                               class="form-control"
                               id="question"
                               name="question"
                               maxlength="80"
                               required>
                        <div class="form-text text-muted">
                            Maximaal 80 tekens.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Toelichting</label>
                        <textarea class="form-control"
                                  id="description"
                                  name="description"
                                  rows="3"
                                  maxlength="220"
                                  required></textarea>
                        <div class="form-text text-muted">
                            Maximaal 220 tekens.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="thumbnail" class="form-label">Thumbnail (afbeelding)</label>
                        <input type="file"
                               class="form-control"
                               id="thumbnail"
                               name="thumbnail"
                               accept="image/*"
                               required>
                        <div class="form-text text-muted">
                            Deze thumbnail wordt gebruikt bij de dialoog.
                        </div>
                    </div>

                    <div class="text-xs text-muted">
                        De standaard looptijd van een peiling is 3 dagen.
                    </div>

                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Annuleren
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Peiling starten
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleTimeForm(pollId) {
    const form = document.getElementById("time-form-" + pollId);
    if (!form) return;
    form.classList.toggle("d-none");
}

function formatDuration(totalSeconds) {
    totalSeconds = Math.max(0, totalSeconds);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const hh = String(hours).padStart(2, "0");
    const mm = String(minutes).padStart(2, "0");
    const ss = String(seconds).padStart(2, "0");
    return hh + ":" + mm + ":" + ss;
}

document.addEventListener("DOMContentLoaded", function () {
    const cards = document.querySelectorAll(".opinion-card");

    cards.forEach(function (card) {
        let secondsLeft = parseInt(card.dataset.remaining || "0", 10);
        const timerValueEl = card.querySelector(".poll-timer-value");
        const statusBadge = card.querySelector(".poll-status-badge");
        const voteArea = card.querySelector(".poll-vote-area");
        const resultsArea = card.querySelector(".poll-results-area");
        const makeDialogueForm = card.querySelector("form[action$='make-dialogue']");

        function setClosedState() {
            card.classList.add("poll-closed");
            if (statusBadge) {
                statusBadge.textContent = "GESLOTEN";
            }
            if (timerValueEl) {
                timerValueEl.textContent = "00:00:00";
            }
            if (voteArea) {
                voteArea.classList.add("d-none");
            }
            if (resultsArea) {
                resultsArea.classList.remove("d-none");
                resultsArea.classList.add("show-results");
            }
            if (makeDialogueForm) {
                makeDialogueForm.classList.remove("d-none");
            }
        }

        if (!timerValueEl) {
            return;
        }

        if (!secondsLeft || secondsLeft <= 0) {
            setClosedState();
            return;
        }

        timerValueEl.textContent = formatDuration(secondsLeft);

        const intervalId = setInterval(function () {
            secondsLeft -= 1;
            if (secondsLeft <= 0) {
                clearInterval(intervalId);
                setClosedState();
                return;
            }
            timerValueEl.textContent = formatDuration(secondsLeft);
        }, 1000);
    });
});
</script>

{% endblock %}
